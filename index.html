<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompleteAPI - La Tua Piattaforma API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Stili di base (Tema Chiaro) */
        body {
            background: linear-gradient(180deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #111827;
            transition: background-color 0.3s, color 0.3s;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #e5e7eb;
        }
        .input-field {
            @apply w-full bg-gray-100 border border-gray-300 rounded-lg py-2 px-4 text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all;
        }
        .nav-link {
            @apply text-gray-600 hover:text-gray-900 transition-colors;
        }
        .card {
             @apply bg-white border border-gray-200 rounded-xl shadow-lg;
        }

        /* Stili Tema Scuro */
        .dark body {
            background: linear-gradient(180deg, #1f2937 0%, #111827 100%);
            color: #d1d5db;
        }
        .dark .glass-effect {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #374151;
        }
        .dark .input-field {
            @apply bg-gray-800 border-gray-700 text-gray-200;
        }
        .dark .nav-link {
            @apply text-gray-400 hover:text-white;
        }
        .dark .card {
            @apply bg-gray-800/80 border-gray-700;
        }

        .btn-primary {
            @apply bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transform hover:-translate-y-0.5 transition-all duration-200;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 transform hover:-translate-y-0.5 transition-all duration-200;
        }
        .dark .btn-secondary {
            @apply bg-gray-700 text-gray-200 hover:bg-gray-600 focus:ring-gray-500;
        }
        
        .page { display: none; }
        .page.active { display: block; }

        .notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="min-h-screen font-sans">

    <!-- Header -->
    <header class="sticky top-0 z-50 glass-effect">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#home" class="text-2xl font-bold dark:text-white">CompleteAPI</a>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#home" class="nav-link">Home</a>
                <a href="#pricing" class="nav-link">Prezzi</a>
                <a href="#docs" class="nav-link">Documentazione</a>
            </div>
            <div class="flex items-center space-x-4">
                <div id="auth-buttons" class="space-x-2">
                    <a href="#login" class="btn-secondary">Login</a>
                    <a href="#register" class="btn-primary">Registrati</a>
                </div>
                <div id="user-menu" class="hidden items-center space-x-4">
                    <span id="user-email" class="font-medium dark:text-white"></span>
                    <a href="#dashboard" class="btn-primary">Dashboard</a>
                    <button id="logout-btn" class="btn-secondary">Logout</button>
                </div>
                <!-- Theme Toggle Button -->
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800">
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z"></path></svg>
                </button>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-12">
        <!-- Login Page -->
        <div id="login" class="page">
            <div class="max-w-md mx-auto">
                <!-- Contenitore per la notifica -->
                <div id="notification-container" class="mb-4"></div>
                
                <div class="card p-8">
                    <h2 class="text-2xl font-bold dark:text-white text-center">Login</h2>
                    <form id="login-form" class="mt-6 space-y-4">
                        <div><label for="login-email" class="block text-sm font-medium text-gray-500 dark:text-gray-400">Email</label><input type="email" id="login-email" class="input-field mt-1" required></div>
                        <div><label for="login-password" class="block text-sm font-medium text-gray-500 dark:text-gray-400">Password</label><input type="password" id="login-password" class="input-field mt-1" required></div>
                        <button type="submit" class="btn-primary w-full !py-3">Accedi</button>
                    </form>
                    <div id="login-error" class="mt-4 text-red-500 text-center"></div>
                </div>
            </div>
        </div>
        
        <!-- Altre pagine -->
        <div id="home" class="page active"><section class="text-center"><h1 class="text-4xl md:text-6xl font-bold dark:text-white leading-tight">Potenzia le Tue Applicazioni con Dati Istantanei</h1><p class="mt-4 text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">La nostra API fornisce accesso in tempo reale a dati finanziari, blockchain e molto altro. Veloce, affidabile e facile da integrare.</p><div class="mt-8"><a href="#pricing" class="btn-primary text-lg px-8 py-3">Inizia Ora - È Gratis</a></div></section></div>
        <div id="pricing" class="page"><section><h2 class="text-3xl font-bold text-center dark:text-white">Piani Tariffari Semplici</h2><p class="text-center mt-2 text-gray-600 dark:text-gray-400">Scegli il piano perfetto per le tue esigenze.</p><div class="mt-10 grid md:grid-cols-3 gap-8"><div class="card p-8 text-center"><h3 class="text-2xl font-semibold dark:text-white">Free</h3><p class="mt-4 text-4xl font-bold dark:text-white">€0<span class="text-lg font-medium text-gray-500 dark:text-gray-400">/mese</span></p><ul class="mt-6 space-y-4 text-gray-600 dark:text-gray-300"><li>50 Richieste/giorno</li><li>Accesso agli endpoint base</li><li>Supporto via community</li></ul><a href="#register" class="mt-8 block btn-secondary w-full">Inizia Gratis</a></div><div class="card p-8 text-center border-2 border-indigo-500 relative"><span class="absolute top-0 -translate-y-1/2 bg-indigo-500 text-white text-sm font-semibold px-3 py-1 rounded-full">Più Popolare</span><h3 class="text-2xl font-semibold dark:text-white">Pro</h3><p class="mt-4 text-4xl font-bold dark:text-white">€10<span class="text-lg font-medium text-gray-500 dark:text-gray-400">/mese</span></p><ul class="mt-6 space-y-4 text-gray-600 dark:text-gray-300"><li>10.000 Richieste/giorno</li><li>Accesso a tutti gli endpoint</li><li>Supporto prioritario via email</li></ul><a href="#register" class="mt-8 block btn-primary w-full">Passa a Pro</a></div><div class="card p-8 text-center"><h3 class="text-2xl font-semibold dark:text-white">Unlimited</h3><p class="mt-4 text-4xl font-bold dark:text-white">€50<span class="text-lg font-medium text-gray-500 dark:text-gray-400">/mese</span></p><ul class="mt-6 space-y-4 text-gray-600 dark:text-gray-300"><li>50.000 Richieste/giorno</li><li>Accesso a tutti gli endpoint</li><li>Accesso anticipato a nuove feature</li></ul><a href="#register" class="mt-8 block btn-secondary w-full">Scegli Unlimited</a></div></div></section></div>
        <div id="docs" class="page"><h2 class="text-3xl font-bold text-center dark:text-white">Documentazione</h2><p class="text-center mt-2 text-gray-600 dark:text-gray-400">La tua API live fornisce automaticamente una documentazione interattiva. Visita <a href="#" id="docs-link" target="_blank" class="text-indigo-500 dark:text-indigo-400 hover:underline">il tuo URL API seguito da /docs</a> per provarla.</p></div>
        <div id="register" class="page"><div class="max-w-md mx-auto card p-8"><h2 class="text-2xl font-bold dark:text-white text-center">Crea un Account</h2><form id="register-form" class="mt-6 space-y-4"><div><label for="register-name" class="block text-sm font-medium text-gray-500 dark:text-gray-400">Nome Completo</label><input type="text" id="register-name" class="input-field mt-1" required></div><div><label for="register-email" class="block text-sm font-medium text-gray-500 dark:text-gray-400">Email</label><input type="email" id="register-email" class="input-field mt-1" required></div><div><label for="register-password" class="block text-sm font-medium text-gray-500 dark:text-gray-400">Password</label><input type="password" id="register-password" class="input-field mt-1" required></div><button type="submit" class="btn-primary w-full !py-3">Registrati</button></form><div id="register-message" class="mt-4 text-center"></div></div></div>
        <div id="dashboard" class="page"><h2 class="text-3xl font-bold dark:text-white">La Tua Dashboard</h2><div class="mt-8 grid md:grid-cols-2 gap-8"><div class="card p-6"><h3 class="text-xl font-semibold dark:text-white">La Tua API Key</h3><p class="text-gray-600 dark:text-gray-400 mt-2">Usa questa chiave nell'header `X-API-Key` delle tue richieste.</p><div class="mt-4 flex items-center space-x-2 bg-gray-100 dark:bg-gray-900 p-3 rounded-lg"><input id="api-key-field" type="text" class="bg-transparent w-full text-gray-800 dark:text-gray-200 font-mono" readonly><button id="copy-key-btn" class="text-gray-400 hover:text-white"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></button></div><button id="regenerate-key-btn" class="mt-4 btn-secondary">Rigenera Chiave</button></div><div class="card p-6"><h3 class="text-xl font-semibold dark:text-white">Utilizzo Giornaliero</h3><p class="text-gray-600 dark:text-gray-400 mt-2">Piano attuale: <span id="plan-name" class="font-semibold text-indigo-500 dark:text-indigo-400"></span></p><div class="mt-4"><div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4"><div id="usage-bar" class="bg-indigo-600 h-4 rounded-full" style="width: 0%;"></div></div><p id="usage-text" class="text-right text-sm text-gray-500 dark:text-gray-400 mt-2">0 / 0 richieste</p></div></div></div></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://completeapi-03it.onrender.com';
            
            // Seleziona tutti gli elementi UI una sola volta
            const ui = {
                pages: document.querySelectorAll('.page'),
                authButtons: document.getElementById('auth-buttons'),
                userMenu: document.getElementById('user-menu'),
                userEmailSpan: document.getElementById('user-email'),
                logoutBtn: document.getElementById('logout-btn'),
                loginForm: document.getElementById('login-form'),
                registerForm: document.getElementById('register-form'),
                loginError: document.getElementById('login-error'),
                registerMessage: document.getElementById('register-message'),
                apiKeyField: document.getElementById('api-key-field'),
                copyKeyBtn: document.getElementById('copy-key-btn'),
                regenerateKeyBtn: document.getElementById('regenerate-key-btn'),
                planName: document.getElementById('plan-name'),
                usageBar: document.getElementById('usage-bar'),
                usageText: document.getElementById('usage-text'),
                themeToggleBtn: document.getElementById('theme-toggle'),
                darkIcon: document.getElementById('theme-toggle-dark-icon'),
                lightIcon: document.getElementById('theme-toggle-light-icon'),
                notificationContainer: document.getElementById('notification-container'),
            };
            
            document.getElementById('docs-link').href = `${API_BASE_URL}/docs`;

            let state = { token: localStorage.getItem('api_token'), user: null };

            // --- GESTIONE NOTIFICHE E TEMA ---
            const applyTheme = () => {
                const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                document.documentElement.classList.toggle('dark', isDark);
                ui.darkIcon.classList.toggle('hidden', !isDark);
                ui.lightIcon.classList.toggle('hidden', isDark);
            };

            const showNotification = (message, type = 'success') => {
                const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
                const icon = type === 'success' ? '✓' : '✗';
                const notificationHTML = `
                    <div class="notification flex items-center ${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg shadow-md" role="alert">
                        <span class="font-semibold mr-2 text-left">${icon}</span>
                        <p>${message}</p>
                    </div>`;
                ui.notificationContainer.innerHTML = notificationHTML;
                setTimeout(() => {
                    const notification = ui.notificationContainer.querySelector('.notification');
                    if (notification) {
                        notification.style.opacity = '0';
                        notification.style.transform = 'translateY(-20px)';
                        setTimeout(() => notification.remove(), 500);
                    }
                }, 4000);
            };

            const checkUrlForMessages = () => {
                const params = new URLSearchParams(window.location.hash.split('?')[1]);
                const message = params.get('message');
                if (message) {
                    const messages = {
                        'verification_success': 'Email verificata con successo! Ora puoi effettuare il login.',
                        'already_verified': 'La tua email era già stata verificata. Effettua il login.',
                        'invalid_token': 'Il link di verifica non è valido o è scaduto.',
                        'user_not_found': 'Utente non trovato. Prova a registrarti di nuovo.'
                    };
                    if (messages[message]) {
                        showNotification(messages[message], message.includes('success') ? 'success' : 'error');
                    }
                    // Pulisce l'URL
                    history.replaceState(null, '', window.location.pathname + '#login');
                }
            };

            // --- ROUTER E LOGICA PRINCIPALE ---
            function navigate() {
                const hash = window.location.hash.split('?')[0] || '#home';
                ui.pages.forEach(page => page.classList.toggle('active', page.id === hash.substring(1)));
                checkUrlForMessages();
            }

            async function fetchWithAuth(endpoint, options = {}) {
                const headers = { 'Content-Type': 'application/json', ...options.headers };
                if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
                    if (response.status === 401) { logout(); return null; }
                    return response;
                } catch (error) {
                    console.error("Fetch error:", error);
                    showNotification("Errore di connessione con il server.", "error");
                    return null;
                }
            }

            function updateUI() {
                const isLoggedIn = state.token && state.user;
                ui.authButtons.classList.toggle('hidden', isLoggedIn);
                ui.userMenu.classList.toggle('hidden', !isLoggedIn);
                if(isLoggedIn) {
                    ui.userMenu.classList.add('flex');
                    ui.userEmailSpan.textContent = state.user.email;
                }
            }

            async function login(email, password) {
                ui.loginError.textContent = '';
                const formData = new URLSearchParams({ username: email, password });
                const response = await fetch(`${API_BASE_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData,
                });
                const data = await response.json();
                if (!response.ok) {
                    ui.loginError.textContent = data.detail || 'Errore di login';
                    return;
                }
                state.token = data.access_token;
                localStorage.setItem('api_token', state.token);
                await loadInitialData();
                window.location.hash = '#dashboard';
            }
            
            async function register(name, email, password) {
                ui.registerMessage.textContent = '';
                const response = await fetchWithAuth('/register', {
                    method: 'POST',
                    body: JSON.stringify({ full_name: name, email, password }),
                });
                if (!response) return;
                const data = await response.json();
                if (!response.ok) {
                    ui.registerMessage.className = 'mt-4 text-center text-red-500';
                    ui.registerMessage.textContent = data.detail || 'Errore di registrazione';
                    return;
                }
                ui.registerMessage.className = 'mt-4 text-center text-green-500';
                ui.registerMessage.textContent = 'Registrazione riuscita! Controlla la tua email per la verifica.';
            }

            function logout() {
                state.token = null; state.user = null;
                localStorage.removeItem('api_token');
                updateUI();
                window.location.hash = '#home';
            }
            
            async function loadInitialData() {
                if (!state.token) { updateUI(); return; }
                const response = await fetchWithAuth('/me');
                if (response && response.ok) {
                    state.user = await response.json();
                    updateUI();
                    updateDashboard();
                } else {
                    logout();
                }
            }

            async function updateDashboard() {
                if (!state.user) return;
                const keyResponse = await fetchWithAuth('/me/api-key');
                if(!keyResponse || !keyResponse.ok) return;
                const keyData = await keyResponse.json();
                ui.apiKeyField.value = keyData.api_key;
                ui.planName.textContent = state.user.subscription_plan.charAt(0).toUpperCase() + state.user.subscription_plan.slice(1);
                const limits = { "free": 50, "pro": 10000, "unlimited": 50000 };
                const maxRequests = limits[state.user.subscription_plan] || 50;
                const usagePercentage = (state.user.requests_today / maxRequests) * 100;
                ui.usageBar.style.width = `${usagePercentage}%`;
                ui.usageText.textContent = `${state.user.requests_today} / ${maxRequests} richieste`;
            }

            async function regenerateApiKey() {
                if (!confirm('Sei sicuro di voler rigenerare la tua API key? La vecchia smetterà di funzionare.')) return;
                const response = await fetchWithAuth('/me/api-key/regenerate', { method: 'POST' });
                if(!response || !response.ok) return;
                const data = await response.json();
                ui.apiKeyField.value = data.api_key;
                showNotification('API Key rigenerata con successo!');
            }
            
            function copyApiKey() {
                ui.apiKeyField.select();
                document.execCommand('copy');
                showNotification('API Key copiata!');
            }

            // --- EVENT LISTENERS ---
            window.addEventListener('hashchange', navigate);
            window.addEventListener('load', () => { applyTheme(); navigate(); });
            
            ui.themeToggleBtn.addEventListener('click', () => {
                localStorage.setItem('theme', document.documentElement.classList.toggle('dark') ? 'dark' : 'light');
                applyTheme();
            });
            ui.loginForm.addEventListener('submit', (e) => { e.preventDefault(); login(document.getElementById('login-email').value, document.getElementById('login-password').value); });
            ui.registerForm.addEventListener('submit', (e) => { e.preventDefault(); register(document.getElementById('register-name').value, document.getElementById('register-email').value, document.getElementById('register-password').value); });
            ui.logoutBtn.addEventListener('click', logout);
            ui.regenerateKeyBtn.addEventListener('click', regenerateApiKey);
            ui.copyKeyBtn.addEventListener('click', copyApiKey);

            loadInitialData();
        });
    </script>
</body>
</html>
